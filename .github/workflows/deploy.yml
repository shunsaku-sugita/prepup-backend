name: app-deploy-workflow
on:
  push:
    branches:
      - prod-stg
jobs:
  deploy:
    name: Deploying NodeJS Application
    runs-on: ubuntu-latest
    env:
      SSH_PRIVATE_KEY: ${{secrets.EC2_SSH_KEY}}
      HOST_NAME: ${{secrets.HOST_DNS}}
      REMOTE_USER: ${{secrets.USERNAME}}
      TARGET: ${{secrets.TARGET_DIR}}
      PORT: ${{secrets.PORT}}
      TOKEN_KEY: ${{secrets.TOKEN_KEY}}
      DB_CONN_STRING: ${{secrets.DB_CONN_STRING}}
      DB_NAME: ${{secrets.DB_NAME}}
      USERS_COLLECTION_NAME: ${{secrets.USERS_COLLECTION_NAME}}
      MAIL_HOST: ${{secrets.MAIL_HOST}}
      MAIL_USERNAME: ${{secrets.MAIL_USERNAME}}
      MAIL_PASSWORD: ${{secrets.MAIL_PASSWORD}}
    steps:
      - uses: actions/checkout@v3
      - name: Deploying application to EC2
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -o StrictHostKeyChecking=no -i private_key ${REMOTE_USER}@${HOST_NAME} "
            echo "Exporting environment variables"
            echo "DB_CONN_STRING: ${DB_CONN_STRING}"
            export PORT=$PORT
            export TOKEN_KEY=$TOKEN_KEY
            export DB_CONN_STRING=$DB_CONN_STRING
            export DB_NAME=$DB_NAME
            export USERS_COLLECTION_NAME=$USERS_COLLECTION_NAME
            export MAIL_HOST=$MAIL_HOST
            export MAIL_USERNAME=$MAIL_USERNAME
            export MAIL_PASSWORD=$MAIL_PASSWORD
            bash /home/ubuntu/node-api/deploy/sync.sh
          "
